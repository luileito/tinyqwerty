/*! tinyqwerty Callout keyboard 2016-05-20 */$(function(){function a(){return!!("ontouchstart"in window)||!!navigator.msMaxTouchPoints}function b(a,b){{var c=b||{};c.strokeColor?c.strokeColor:ca,c.fillColor?c.fillColor:da,c.textColor?c.textColor:ea}a=l(a),$('<div class="key" />').css({left:a.x,top:a.y,width:a.width,height:a.height,"font-size":.9*a.width}).data(a).text(a["char"]).appendTo(G)}function c(a){E.register(E.event.CALLOUT,a),O.data("char",a)," "===a&&(a="&#9251;"),O.html(a).show()}function d(a){G.html("");for(var c=D.getKeys(a),d=0,e=c.length;e>d;d++)b(c[d]);A(D.keyboard.layouts[a].name,"#66CCFF"),E.register(E.event.LOAD,a)}function e(a){var b=a.originalEvent,c={x:b.pageX,y:b.pageY};if(aa){var d=b.touches[0]||b.changedTouches[0];c.x=d.pageX,c.y=d.pageY}return c}function f(a){var b=P[0],c=I.height();return{x:a.x-b.offsetLeft,y:a.y-b.offsetTop-c}}function g(a){Z=!0;var b=f(e(a));E.register(E.event.PRESS,b),p(),n(a)}function h(a){if(Z){var b=f(e(a));E.register(E.event.MOVE,b),n(a)}}function i(a){Z=!1;var b=f(e(a));E.register(E.event.RELEASE,b),p();var c=O.data("char");c&&x(c)}function j(a){Z=!1;var b=f(e(a));E.register(E.event.ENTER,b),p()}function k(a){Z=!1;var b=f(e(a));E.register(E.event.LEAVE,b),p()}function l(a){var b=D.measure(Y),c=ba.width/b.width*.9,d=b.width*c,e=b.height*c,f=(ba.width-d)/2,g=(ba.height-e)/2;return{x:f+a.x*c,y:g+a.y*c,width:a.width*c,height:a.height*c,"char":a["char"]}}function m(a){for(var b,c,d=D.getKeys(Y),e=Number.MAX_VALUE,f=null,g=0,h=d.length;h>g;g++){if(b=d[g],c=$.extend({},b),b=l(b),a.x>b.x&&a.x<b.x+b.width&&a.y>b.y&&a.y<b.y+b.height){f=c;break}var i=b.x+b.width/2,j=b.y+b.height/2,k=Math.pow(a.x-i,2)+Math.pow(a.y-j,2);e>k&&(e=k,f=c)}return f}function n(a){var b,d=o(a);if(d.hasClass("key"))b=d.data();else{var g=f(e(a));b=m(g)}var h=b?b["char"]:null;c(h)}function o(a){var b;if(aa){var c=a.originalEvent,d=c.touches[0]||c.changedTouches[0];b=document.elementFromPoint(d.pageX,d.pageY)}else b=a.target;return $(b)}function p(){Z?(O.show(),L.addClass("highlighted")):(O.text("").hide(),L.removeClass("highlighted"))}function q(a){function b(){H.off("touchmove.swipe touchend.swipe mousemove.swipe mouseup.swipe")}a.preventDefault();var c=e(a),d=a.timeStamp;H.on("touchmove.swipe mousemove.swipe",function(a){var f=e(a),g=a.timeStamp,h=c.x-f.x,i=c.y-f.y;fa>g-d&&(Math.abs(h)>=ga?h>0?(y(D.swipeKey.LEFT),b()):(y(D.swipeKey.RIGHT),b()):Math.abs(i)>=ha&&(i>0?(y(D.swipeKey.DOWN),b()):(y(D.swipeKey.UP),b())))}),H.on("touchend.swipe mouseup.swipe",b)}function r(a){A(a),a=a.toLowerCase(),E.register(E.event.TYPE,a),L.append(a),O.data("char",null),M.scrollTop(M[0].scrollHeight)}function s(){A("&#8656;"),L.contents().last().remove()}function t(){A("&#8629;");var a=L.text(),b=F.param("uid"),c=F.decode(F.param("txt"));E.register(E.event.SUBMIT,a),alert("You typed: '"+a+"'"),L.text(""),b&&c&&E.finish({uid:b,phrase:c,kbdsize:S},function(a){var b=JSON.parse(a);b.err>0?alert(b.msg):window.top.location.reload()})}function u(){if(A("&#9251;"),Q){var a=L.text().split(" ").pop();v(a)}L.append(D.actionKey.SPACE)}function v(a){return""===$.trim(a)?a:void R.check(a,function(a){var b=a[0];if(b.length>0)for(var c=0,d=b.length;d>c;c++){var e=b[c];R.getSuggestions(e,function(a){if(a){var b=a[0],c=L.text().replace(e,b);w(c)}})}})}function w(a){var b=a.split("");L.contents().remove();for(var c=0,d=b.length;d>c;c++)r(b[c])}function x(a){if(!_){switch(a){case D.actionKey.ENTER:t();break;case D.actionKey.DELETE:s();break;case D.actionKey.SPACE:u();break;default:r(a)}E.register(E.event.TEXT_CHANGE,L.text())}}function y(a){switch(_=!0,E.register(E.event.SWIPE,a),a){case D.swipeKey.LEFT:s();break;case D.swipeKey.RIGHT:u();break;case D.swipeKey.UP:C(++Y);break;case D.swipeKey.DOWN:C(--Y)}setTimeout(function(){_=!1},fa)}function z(a){return void 0===typeof a.which?!0:"number"==typeof a.which&&a.which>0?!a.ctrlKey&&!a.metaKey&&!a.altKey&&8!=a.which:!1}function A(a,b){b=b||"white",clearTimeout(X),J.html(a),K.css({zIndex:1,opacity:.5}).show();var c=J.width(),d=J.height(),e=K.width(),f=K.height(),g=K.position();J.css({zIndex:2,color:b,top:g.top+(f-d)/2,left:g.left+(e-c)/2}),X=setTimeout(function(){J.html(""),K.css({zIndex:0,opacity:0}).hide()},250)}function B(a,b){H.on(a,function(a){a.preventDefault(),b(a)})}function C(a){O.hide(),K.hide(),0>a?a=D.keyboard.layouts.length-1:a>D.keyboard.layouts.length-1&&(a=0),Y=a,d(a),L.removeClass("highlighted")}var D=require("./kbd.min"),E=require("../common/log.min"),F=require("../common/url.min");E.config({excludeEvents:[E.event.ENTER,E.event.LEAVE],saveUrl:"results/save.php"});var G=$(".keyboard"),H=$(".k-container"),I=$(".t-container"),J=$(".message"),K=$(".overlay"),L=$(".typed"),M=$(".typed-wrap"),N=$(".cursor"),O=$(".hint"),P=$(".kbd-widget");!function(){var a=1;setInterval(function(){N.css({color:a%2===0?"black":"transparent"}),a++},700)}();var Q=F.param("spell");if(Q){require("jquery.spellchecker.min");var R=new $.SpellChecker(null,{lang:Q,parser:"text",webservice:{path:"../common/spellservice/SpellChecker.php",driver:"PSpell"}})}var S=parseInt(F.param("size"),10)||150,T=P.width()/P.height(),U=S,V=S/T,W=V/2*.8;P.css({width:U,height:V}),H.css({width:U,height:V/2}),I.css({width:U,height:V/2}),M.css({width:U-2,height:V/2,"font-size":V/6}),G.css({width:U,height:V/2}),O.css({width:W,height:W,"font-size":.8*W,top:(M.height()-W)/2,left:(M.width()-W)/2}),J.css("font-size",V/2*.8);var X,Y=0,Z=!1,_=!1,aa=a(),ba={width:H.width(),height:H.height()},ca="#DDD",da="#CCC",ea="#000",fa=150,ga=ba.width/5,ha=ba.height/4;if(aa){var ia={touchstart:g,touchmove:h,touchend:i,touchenter:j,touchleave:k};for(var ja in ia)B(ja,ia[ja])}else H.on("mousedown",g).on("mousemove",h).on("mouseup",i).on("mouseleave",k).on("mouseenter",j);$(document).keypress(function(a){a.preventDefault();var b=a.keyCode||a.which,c=String.fromCharCode(b);z(a)&&x(c)}),$(document).keydown(function(a){var b=a.keyCode||a.which;37===b?y(D.swipeKey.LEFT):39===b?y(D.swipeKey.RIGHT):38===b?y(D.swipeKey.UP):40===b?y(D.swipeKey.DOWN):8===b?(a.preventDefault(),x(D.actionKey.DELETE)):13===b&&x(D.actionKey.ENTER)}),H.on("touchstart.swipe mousedown.swipe",q),M.click(t),$(document).on("selectstart",function(a){a.preventDefault()}),C(Y)});