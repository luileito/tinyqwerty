/*! tinyqwerty ZShift keyboard 2015-03-16 */$(function(){function a(){return!!("ontouchstart"in window)||!!navigator.msMaxTouchPoints}function b(a,b){if(a){var c=b||{},d=c.strokeColor?c.strokeColor:db,e=c.fillColor?c.fillColor:eb,f=c.textColor?c.textColor:fb;a=l(a);var g=o(G[0]);g.fillStyle=e,g.strokeStyle=d,g.clearRect(a.x,a.y,a.width,a.height),g.beginPath(),g.rect(a.x,a.y,a.width,a.height),g.fill(),g.stroke(),g.font="bold "+1.2*a.width/2+"pt sans-serif",g.textAlign="center",g.textBaseline="middle",g.fillStyle=f,g.fillText(a["char"],a.x+a.width/2,a.y+a.height/2)}}function c(a){E.register(E.event.CALLOUT,a["char"]),b(a,{fillColor:"#FF9966",textColor:"#000000",strokeColor:"#CC3300"})}function d(a){var c=D.getKeys(a),d=G[0],e=O[0],f=cb;d.width=e.width=bb.width*f,d.height=e.height=bb.height*f;var g=o(d);g.fillStyle="black",g.fillRect(0,0,d.width,d.height);for(var h=0;h<c.length;h++)b(c[h]);X=null,A(D.keyboard.layouts[a].name,"#66CCFF"),E.register(E.event.LOAD,a)}function e(a){var b=a.originalEvent,c={x:b.pageX,y:b.pageY};if(ab){var d=b.touches[0]||b.changedTouches[0];c.x=d.pageX,c.y=d.pageY}return c}function f(a){var b=P[0],c=I.height(),d=cb;return{x:(a.x-b.offsetLeft)*d,y:(a.y-b.offsetTop-c)*d}}function g(a){Z=!0;var b=f(e(a));E.register(E.event.PRESS,b),p(),n(a)}function h(a){if(Z){var b=f(e(a));E.register(E.event.MOVE,b),n(a)}}function i(a){Z=!1;var c=f(e(a));E.register(E.event.RELEASE,c),p(),b(X),x(m(c)["char"])}function j(a){Z=!1;var c=f(e(a));E.register(E.event.ENTER,c),b(X),p()}function k(a){Z=!1;var c=f(e(a));E.register(E.event.LEAVE,c),b(X),p()}function l(a){var b=D.measure(Y),c=cb,d=bb.width/b.width*.9*c,e=b.width*d,f=b.height*d,g=(bb.width*c-e)/2,h=(bb.height*c-f)/2;return{x:g+a.x*d,y:h+a.y*d,width:a.width*d,height:a.height*d,"char":a["char"]}}function m(a){for(var b,c,d=D.getKeys(Y),e=Number.MAX_VALUE,f=null,g=0,h=d.length;h>g;g++){if(b=d[g],c=$.extend({},b),b=l(b),a.x>b.x&&a.x<b.x+b.width&&a.y>b.y&&a.y<b.y+b.height){f=c;break}var i={x:b.x+b.width/2,y:b.y+b.height/2},j=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2);e>j&&(e=j,f=c)}return f}function n(a){var d=G[0],g=O[0],h=f(e(a)),i=m(h),j=cb,k={width:S/2*j,height:S/2*j},l=k.width/2,n=k.height/2,p=h.x-(k.width-l)/2,q=h.y-(k.height-n)/2;p+l>g.width&&(p=g.width-l),q+n>g.height&&(q=g.height-n),0>p&&(p=0),0>q&&(q=0);var r=g.height/2*.9,s=2.5*r,t=s,u=(g.width-s)/2,v=(g.height-t)/2,w=o(g);g.width=g.width,w.beginPath(),w.arc(g.width/2,g.height/2,r,0,2*Math.PI,!1);var x=D.measure(Y),y=bb.width/x.width;w.lineWidth=1*y*j,w.stroke(),w.beginPath(),w.arc(g.width/2,g.height/2,r,0,2*Math.PI,!1),w.clip(),c(i),w.drawImage(d,p,q,l,n,u,v,s,t),b(X),X=i}function o(a){var b=a.getContext("2d");return b.imageSmoothingEnabled=!1,b.mozImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.antialias="nearestneighbour",b}function p(){Z?(O.show(),L.addClass("highlighted")):(O.hide(),L.removeClass("highlighted"))}function q(a){function b(){H.off("touchmove.swipe touchend.swipe mousemove.swipe mouseup.swipe")}a.preventDefault();var c=e(a),d=a.timeStamp;H.on("touchmove.swipe mousemove.swipe",function(a){var f=e(a),g=a.timeStamp,h=c.x-f.x,i=c.y-f.y;gb>g-d&&(Math.abs(h)>=hb?h>0?(y(D.swipeKey.LEFT),b()):(y(D.swipeKey.RIGHT),b()):Math.abs(i)>=ib&&(i>0?(y(D.swipeKey.DOWN),b()):(y(D.swipeKey.UP),b())))}),H.on("touchend.swipe mouseup.swipe",b)}function r(a){A(a),a=a.toLowerCase(),E.register(E.event.TYPE,a),L.append(a),O.data("char",null),M.scrollTop(M[0].scrollHeight)}function s(){A("&#8656;"),L.contents().last().remove()}function t(){A("&#8629;");var a=L.text(),b=F.param("uid"),c=F.decode(F.param("txt"));E.register(E.event.SUBMIT,a),alert("You typed: '"+a+"'"),L.text(""),b&&c&&E.finish({uid:b,phrase:c,kbdsize:S},function(a){var b=JSON.parse(a);b.err>0?alert(b.msg):window.top.location.reload()})}function u(){if(A("&#9251;"),Q){var a=L.text().split(" ").pop();v(a)}L.append(D.actionKey.SPACE)}function v(a){return""===$.trim(a)?a:void R.check(a,function(a){var b=a[0];if(b.length>0)for(var c=0,d=b.length;d>c;c++){var e=b[c];R.getSuggestions(e,function(a){if(a){var b=a[0],c=L.text().replace(e,b);w(c)}})}})}function w(a){var b=a.split("");L.contents().remove();for(var c=0,d=b.length;d>c;c++)r(b[c])}function x(a){if(!_){switch(a){case D.actionKey.ENTER:t();break;case D.actionKey.DELETE:s();break;case D.actionKey.SPACE:u();break;default:r(a)}E.register(E.event.TEXT_CHANGE,L.text())}}function y(a){switch(_=!0,E.register(E.event.SWIPE,a),a){case D.swipeKey.LEFT:s();break;case D.swipeKey.RIGHT:u();break;case D.swipeKey.UP:C(++Y);break;case D.swipeKey.DOWN:C(--Y)}setTimeout(function(){_=!1},gb)}function z(a){return void 0===typeof a.which?!0:"number"==typeof a.which&&a.which>0?!a.ctrlKey&&!a.metaKey&&!a.altKey&&8!=a.which:!1}function A(a,b){b=b||"white",clearTimeout(W),J.html(a),K.css({zIndex:1,opacity:.5}).show();var c=J.width(),d=J.height(),e=K.width(),f=K.height(),g=K.position();J.css({zIndex:2,color:b,top:g.top+(f-d)/2,left:g.left+(e-c)/2}),W=setTimeout(function(){J.html(""),K.css({zIndex:0,opacity:0}).hide()},250)}function B(a,b){H.on(a,function(a){a.preventDefault(),b(a)})}function C(a){O.hide(),K.hide(),0>a?a=D.keyboard.layouts.length-1:a>D.keyboard.layouts.length-1&&(a=0),Y=a,d(a)}var D=require("./kbd.min"),E=require("log.min"),F=require("url.min");E.config({excludeEvents:[E.event.ENTER,E.event.LEAVE],saveUrl:"results/save.php"});var G=$(".keyboard"),H=$(".k-container"),I=$(".t-container"),J=$(".message"),K=$(".overlay"),L=$(".typed"),M=$(".typed-wrap"),N=$(".cursor"),O=$(".hint"),P=$(".kbd-widget");!function(){var a=1;setInterval(function(){N.css({color:a%2===0?"black":"transparent"}),a++},700)}();var Q=F.param("spell");if(Q){require("jquery.spellchecker.min");var R=new $.SpellChecker(null,{lang:Q,parser:"text",webservice:{path:"../common/spellservice/SpellChecker.php",driver:"PSpell"}})}var S=parseInt(F.param("size"),10)||150,T=P.width()/P.height(),U=S,V=S/T;P.css({width:U,height:V}),H.css({width:U,height:V/2}),I.css({width:U,height:V/2}),M.css({width:U-2,height:V/2,"font-size":V/6}),O.css({width:U,height:V/2}),G.css({width:U,height:V/2}),J.css("font-size",V/2*.8);var W,X,Y=0,Z=!1,_=!1,ab=a(),bb={width:H.width(),height:H.height()},cb=2,db="#DDDDDD",eb="#DDDDDD",fb="#000000",gb=150,hb=bb.width/5,ib=bb.height/4;if(ab){var jb={touchstart:g,touchmove:h,touchend:i,touchenter:j,touchleave:k};for(var kb in jb)B(kb,jb[kb])}else H.on("mousedown",g).on("mousemove",h).on("mouseup",i).on("mouseleave",k).on("mouseenter",j);$(document).keypress(function(a){a.preventDefault();var b=a.keyCode||a.which,c=String.fromCharCode(b).toLowerCase();z(a)&&x(c)}),$(document).keydown(function(a){var b=a.keyCode||a.which;37===b?y(D.swipeKey.LEFT):39===b?y(D.swipeKey.RIGHT):38===b?(y(D.swipeKey.UP),a.preventDefault()):40===b?(y(D.swipeKey.DOWN),a.preventDefault()):8===b?(a.preventDefault(),x(D.actionKey.DELETE)):13===b&&x(D.actionKey.ENTER)}),H.on("touchstart.swipe mousedown.swipe",q),M.click(t),$(document).on("selectstart",function(a){a.preventDefault()}),C(Y)});